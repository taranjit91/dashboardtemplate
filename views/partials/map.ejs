<label id="devicesJson"><%= JSON.stringify(jsonResponse) %></label>
<div id="map">

</div>


<script>
    function initMap() {
        var htmString = document.getElementById('devicesJson').innerHTML;
        var json = JSON.parse(htmString);
        var devicess = json.user.device;

        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;



        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 13,
            center: {

                lat: 43.772959,
                lng: -79.257609
            }

        });

        var cityCircle = new google.maps.Circle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.35,
            map: map,
            center: {
                lat: 43.775293,
                lng: -79.257825
            },
            radius: 1000
        });

        var marker1 = new google.maps.Marker({
            position: {
                lat: 43.775293,
                lng: -79.257825
            },
            draggable: true,
            map: map,
            title: "Geofence Center"
        });
        marker1.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');

        //     for (count = 0; count < devicess.length; count++) {
        //         var myLatLng = {
        //             lat: devicess[count].geofence_latitude,
        //             lng: devicess[count].geofence_longitude
        //         };
        //         var marker = new google.maps.Marker({
        //             position: myLatLng,

        //             map: map,
        //             title: devicess[count].device_name
        //         });

        //     }
        // }

        google.maps.event.addListener(marker1, 'drag', function(event) {
            console.debug('new position is ' + event.latLng.lat() + ' / ' + event.latLng.lng());
        });
        google.maps.event.addListener(marker1, 'dragend', function(event) {
            console.debug('final position is ' + event.latLng.lat() + ' / ' + event.latLng.lng());
            console.log(cityCircle);
            cityCircle.map = null;
            var cityCircle = new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: map,
                center: {
                    lat: event.latLng.lat(),
                    lng: event.latLng.lng()
                },
                radius: 1000
            });
        });

        function geocodePosition(pos) {
            geocoder = new google.maps.Geocoder();
            geocoder.geocode({
                    latLng: pos
                },
                function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        //$("#mapSearchInput").val(results[0].formatted_address);
                        // $("#mapErrorMsg").hide(100);
                    } else {
                        // $("#mapErrorMsg").html('Cannot determine address at this location.'+status).show(100);
                    }
                }
            );
        }
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4CxwlDf09EE5-hIhqyMRuVZpRlK6K3PE&callback=initMap" async>
</script>